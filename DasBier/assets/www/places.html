<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<title>Places to Get Drunk [dotcom]</title>
    <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }
      #map_canvas { height: 100% }
    </style>
    	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
    
    <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?libraries=places&sensor=false"></script>

    <script type="text/javascript">
	  var map;
      var infowindow;
	  var request;
	  var markersarray =[];
	  var denton;
	  var populararray =[213362,16764,20787,196627,103776,114265,214214];
	  
      function initialize() {
		denton = new google.maps.LatLng(33.216646,-97.133646);
		var mapOptions = {
			mapTypeId: google.maps.MapTypeId.ROADMAP,
            center: denton,
			zoom: 16
		};
		
        map = new google.maps.Map(document.getElementById('map_canvas'),mapOptions);
				
        request = {
          location: denton,
          radius: 15000,
          types: [],
		  keyword: "bar"
		  
        };
        infowindow = new google.maps.InfoWindow({
        	maxWidth:200
        });
        var service = new google.maps.places.PlacesService(map);
        service.search(request, callback);
      }

      function callback(results, status) {
        if (status == google.maps.places.PlacesServiceStatus.OK) {
          for (var i = 0; i < results.length; i++) {
            createMarker(results[i]);
          }
        }
      }
	  
	  function changePlaces(type){
		request.keyword=type;
		var serv= new google.maps.places.PlacesService(map);
		serv.search(request, callback);
	  }
	  
	  function clickSearch(){
			clearOverlays();
			changePlaces(document.getElementById('searchText').value);
	  
	  }
	  
	  function clickBars(){
			clearOverlays();
			changePlaces("bars");
		}
	  
		
		
		function clearOverlays() {
			if (markersarray) {
				for (i in markersarray) {
					markersarray[i].setMap(null);
				}
			}			
		}		
		
		function clickPop(){
			
			clickPopular(populararray[1]);
		}
		
		function clickPopular(popID){
			clearOverlays();
			var placeLoc;
			var placeName;
			var placeAddr;
			var placeIcon;
			
			var popURL;
			
			popURL="http://api.untappd.com/v3/venue_info?key=b6077c9e633e11b65375b25eea792597&venue_id="+popID;
			$.ajax({
					url: popURL,
					dataType: "json",		
					success:function(result){
							placeLoc = new google.maps.LatLng(result.results.geolat,result.results.geolng);
							placeName= result.results.name;
							placeAddr= result.results.address;
							placeIcon= result.results.img;
							
							$("#results").html(result.results.geolat + " " + result.results.geolng + " " + placeName + " " + placeAddr);

						}, //end success
					error: function(req, status, errThrown){
							$("#results").html("error:" + req + status + errThrown);
						}
					  		
			  }); //end AJAX

			var contentTxt;
	        
	        var marker = new google.maps.Marker({
	          map: map,
	          position: placeLoc
	        });
			markersarray.push(marker);

	        google.maps.event.addListener(marker, 'click', function() {
	         			  			  
	            $.ajax({url:"http://api.untappd.com/v3/venue_checkins?key=b6077c9e633e11b65375b25eea792597&venue_id="+populararray[0],
	            	type:"GET",
	            	dataType: "json",
	            	success:function(result){
	            		contentTxt = 
	    					'<p>Name = '+placeName + 
	    					'<br>'+
	    					'<img src="'+placeIcon+'">'+
	    					'<br>' + 
	    					'<p>Address = '+placeAddr+
	    					
	    					'<br>' +
	    					'<div id="barFeed"></div>';
	    					$.each(result.results, function(i,checkin){
	    					     // this is where we do what we want with the beer
	    					      $("#barFeed").append('<p><img id="beerpic" title="'+checkin.checkin_id+'" src="'+checkin.beer_stamp+'" width="48" height="48" />'+checkin.beer_name+'</p>');

	    							});
	    					
	    					
	    					infowindow.setContent(contentTxt);
	    			    },
	            	error: function(req, status, errThrown){
	            	$("#results").html("error:" + req + status + errThrown);
	            	}

	            	  }); //end AJAX
					infowindow.open(map, this);
			});
			  
	          
	        } //end clickPopular()

	  
	  
      function createMarker(place) {
	  var contentTxt;
        var placeLoc = place.geometry.location;
        var marker = new google.maps.Marker({
          map: map,
          position: place.geometry.location
        });
		markersarray.push(marker);

        google.maps.event.addListener(marker, 'click', function() {
          var detailRequest = {
		  reference: place.reference
		  };
		  
		  service = new google.maps.places.PlacesService(map);
			service.getDetails(detailRequest, deetz);

			function deetz(place, status) {
				if (status == google.maps.places.PlacesServiceStatus.OK) {
				contentTxt = 
				'<p>Name = '+place.name + 
				'<br>'+
				'<img src="'+place.icon+'">'+
				'<br>' + 
				'<p>Address = '+place.formatted_address+
				
				'<br>';
				infowindow.setContent(contentTxt);
				
  }
}
		  
		  //infowindow.setContent(place.icon);		  
          infowindow.open(map, this);
        });
      }

      google.maps.event.addDomListener(window, 'load', initialize);
    </script>
  </head>
  <body onload="initialize()">
    <div id="map_canvas" style="width:100%; height:75%"></div>
	<br>
	<input type="text" id="searchText" onkeydown="if (event.keyCode == 13) document.getElementById('search_button').click()">
	<button id="search_button" onclick="clickSearch()">Search</button>
	<br>
	<button id="change_type" onclick="clickBars()">Bars</button>
	<button id="popBeers" onClick="clickPop()">Popular</button>
	<br>
	<button id="clear_markers" onclick="clearOverlays()">Clear</button>
	<div id="results"></div>
  </body>
</html>