<!DOCTYPE HTML>
<html>
<head>
<meta>
<title>BierTime</title>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
<script type="text/javascript" src="http://crypto-js.googlecode.com/files/2.5.3-crypto-md5.js"></script> 
<script type="text/javascript" charset="utf-8" src="phonegap-1.4.1.js"></script>
<link rel="stylesheet" href="http://code.jquery.com/mobile/1.0a4.1/jquery.mobile-1.0a4.1.min.css" />


<!--when run locally (ie, not on a webserver) there is an error for security reasons.  the URL json call should work when the page is live-->
<!--until then, we have a json test file to make sure the syntax for working with it works-->
<!--http://api.untappd.com/v3/user?key=b6077c9e633e11b65375b25eea792597&user=mmmmikep -->
<!--file:///C:/Users/KRISTINAKICKASS/jsontest.txt-->
<script type="text/javascript">

var authString;
var distinctOffset;

function initialize(){
	 var username = 'mmmmikep';
	 var password = 'icarus';
	 var passwordHash = Crypto.MD5(password);
	 authString = btoa(username + ':' + passwordHash); 

	 var url = "http://api.untappd.com/v3/user?key=b6077c9e633e11b65375b25eea792597&user="+username;
	 var key = "key=b6077c9e633e11b65375b25eea792597";
	 var query = '&user=mmmmikep';

	 var userAPIcall = "http://api.untappd.com/v3/user?key=b6077c9e633e11b65375b25eea792597&user=";
	 var beerAPIcall = "http://api.untappd.com/v3/beer_search?key=b6077c9e633e11b65375b25eea792597&sort=count&q=";
	 var beerInfocall = "http://api.untappd.com/v3/beer_info?key=b6077c9e633e11b65375b25eea792597&bid=";
	 var untappdAPIcall="";
	 var backbutton = "Back that thing up";
	 distinctOffset = 0;
	 beerTrends();


		
}



//preference activity

function beerTrends(){
	var trendURL = "http://api.untappd.com/v3/trending?key=b6077c9e633e11b65375b25eea792597&type=local&limit=10&age=monthly&geolat=33.216646&geolng=-97.133646";
	backbutton = $("#results").val;
	
	$.ajax(
			{
			url: trendURL,
			dataType: "json",		
			success:function(result){
				$("#status").html("Popular beers in the Denton area<br>Click on a beer for more info!");
				
			      $.each(result.results, 
			    		  function(i,beer){
				     	// this is where we do what we want with the beer
				      		$("#results").html('<p onclick="beerclick('+beer.beer_id+')"><img id="beerpic" title="'+beer.beer_id+'" src="'+beer.img+'" width="48" height="48" />'+beer.beer_name+'</p>');
						});	//end each function
			      }, //end success
			error: function(req, status, errThrown){
					$("#results").html("error:" + req + status + errThrown);
				}
			  		
	  });
	
	
}

function myBeers(){
	distinctOffset=0;
	
}
function beerlist(url){
	var bidURL = url;
	var offset;
	var testURL = 'http://api.untappd.com/v3/user_distinct?key=b6077c9e633e11b65375b25eea792597&user=mmmmikep&offset=';
	var nextURL = 'http://api.untappd.com/v3/user_distinct?key=b6077c9e633e11b65375b25eea792597&user=mmmmikep&offset=' + offset;
	var prevOffset;
	
	
	backbutton = $("#results").val;
	$("#status").html("searching...");

	
	$.ajax(
		{
		url:bidURL,
		dataType: "json",		
		success:function(result){
			
			$("#status").html("Tap a beer for more info!");


			
		      $.each(result.results, 
		    		  function(i,beer){
			     	// this is where we do what we want with the beer
			      		$("#results").append('<p onclick="beerclick('+beer.beer_id+')"><img id="beerpic" title="'+beer.beer_id+'" src="'+beer.beer_stamp+'" width="48" height="48" />'+beer.beer_name+'</p>');
			     		offset = i;
					});	//end each function

					distinctOffset = distinctOffset + offset + 1;
					nextURL = "http://api.untappd.com/v3/user_distinct?key=b6077c9e633e11b65375b25eea792597&user=mmmmikep&offset=" + distinctOffset;

					//next page button not working for some reason
		    $("#nav").html('<button onclick="beerlist(&#34;'+nextURL+'&#34;)">More Beer?</button><br>');

					}, //end success
		error: function(req, status, errThrown){
				$("#results").html("error:" + req + status + errThrown);
			}
		  		
  });
	
}




function beerclick(uid){
	var bidURL = "http://api.untappd.com/v3/beer_info?key=b6077c9e633e11b65375b25eea792597&bid="+uid;
	backbutton = $("#results").val;
	var key = '';
	var Bindex=0;

	$("#status").html('Searching for...');
    $("#status").append(uid);
	
    $.ajax({url:bidURL,
    	type:"GET",
    	dataType: "json",
    	beforeSend: function (xhr) {xhr.setRequestHeader('Authorization', 'Basic ' + authString); },
    	success:function(result){

    	$("#status").html("Rate, Review, and Check in to this beer!");       
    	$("#results").html('<p><img src="'+result.results.img+'" width="125" height="125""><br>'+result.results.name+'</p>'+
    	'<p>'+result.results.type+' - ABV: '+result.results.beer_abv+'%</p>'+
    	'<p>--'+result.results.brewery+'</p>');
    	
    	$("#results").append('My Rating: '+result.results.your_rating +'<br>');
    	$("#results").append('Average Rating: '+result.results.avg_rating +"<br>");

    	$("#nav").html('<button id="checkIn" onclick="beerCheckin('+uid+')">Check In!</button>');



    	    
    	},
    	error: function(req, status, errThrown){
    	$("#results").html("error:" + req + status + errThrown);
    	}

    	  });
	}


  function searchBeer(){
	  clearPage();
	  backbutton = $("#results").val;
		$("#status").html("Searching...");

		untappdAPIcall = "http://api.untappd.com/v3/beer_search?key=b6077c9e633e11b65375b25eea792597&sort=count&q="+$("#searchText").val();
    $.getJSON("http://api.untappd.com/v3/beer_search?key=b6077c9e633e11b65375b25eea792597&sort=count&q="+$("#searchText").val(),function(json){
		$("#status").html("Tap a beer for more info!");

      $.each(json.results, function(i,beer){
     // this is where we do what we want with the beer
      $("#results").append('<p onclick="beerclick('+beer.beer_id+')"><img id="beerpic" title="'+beer.beer_id+'" src="'+beer.beer_stamp+'" width="48" height="48" />'+beer.beer_name+'</p>');

		});
    
	});
  }
  
  function goBack(){
	  $("#results").html(""+backbutton);
  }
  
  function beerCheckin(id){
	  checkinURL="http://api.untappd.com/v3/checkin?key=b6077c9e633e11b65375b25eea792597";
	  $("#status").html("checking in... ");
	  var review=prompt("Please write a short review of this beer","Reviewed with DentonBierGarten");
	  var rating=prompt("Please review this beer on a scale from 1-5","0");
	  
	  $.ajax({url: checkinURL,
	    	type:"POST",
	    	dataType: "json",
	    	data: { bid: id, gmt_offset: -6, shout: review, rating_value: rating},
	    	beforeSend: function (xhr) {xhr.setRequestHeader('Authorization', 'Basic ' + authString); },
	    	success:function(result){
	    		$("#status").html("Success! See recommendations below");
		    	$("#results").html(result.beer_details.beer_name +'<br><img src="'+result.beer_details.img+'" width="72" length="72"><br>'+result.beer_details.brewery_name+'<br><hr>');
		    	$.each(result.recommendations, 
			    		  function(i,rec){
				     	// this is where we do what we want with the beer
				      		$("#results").append('<p onclick="beerclick('+rec.beer_id+')"><img id="beerpic" title="'+rec.beer_id+'" src="'+rec.img+'" width="48" height="48" />'+rec.beer_name+'</p>');
						});

		    	

	    	
	    	    
	    	},
	    	error: function(req, status, errThrown){
	    	$("#results").html("error:" + req + status + errThrown);
	    	}

	    	  });
	  
  }

  function clearPage(){
	  $("#results").html("");
	  $("#status").html("");
	  $("#nav").html("");

  }
</script>		  


</head>
<body onload="initialize()" bgcolor="#f5ad03" style="margin: 0; padding: 0">
<style> body{
background-image:url("http://i15.photobucket.com/albums/a377/TheAmelianator/bubblybeer.jpg");
background-repeat:no-repeat;
background-attachment:scrollable;
 



}</style>




<p><font color="#6A2C0C" face="Gill Sans">Enter a beer to search</font></p><input type="text" id="searchText">
<button id="bSrch" onclick="searchBeer()">Search Beers</button>
<button id="trend" onclick="beerTrends()">Popular Beers</button>
<button id="clearclick" onclick="clearPage()">Clear</button>


<button id="beers" onclick="myBeers();clearPage();beerlist('http://api.untappd.com/v3/user_distinct?key=b6077c9e633e11b65375b25eea792597&user=mmmmikep&offset=')">My Beers</button>
<br><br>
<!-- <button id="backButton" onclick="goBack()">Back</button> -->
<div id="status"></div>
<div id="nav"></div>
<div id="results"></div>






</body>
</html>