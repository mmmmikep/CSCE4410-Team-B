<!DOCTYPE HTML>
<html>
<head>
<meta>
<title>BierTime</title>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
<script type="text/javascript" src="http://crypto-js.googlecode.com/files/2.5.3-crypto-md5.js"></script> 

<!--when run locally (ie, not on a webserver) there is an error for security reasons.  the URL json call should work when the page is live-->
<!--until then, we have a json test file to make sure the syntax for working with it works-->
<!--http://api.untappd.com/v3/user?key=b6077c9e633e11b65375b25eea792597&user=mmmmikep -->
<!--file:///C:/Users/KRISTINAKICKASS/jsontest.txt-->
<script type="text/javascript">

//Read a page's GET URL variables and return them as an associative array.
function getUrlVars()
{
	var vars = [], hash;
	var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
	for(var i = 0; i < hashes.length; i++)
	{
		hash = hashes[i].split('=');
		vars.push(hash[0]);
		vars[hash[0]] = hash[1];
	}
	return vars;
}





var username;
var password;
var authString;

var distinctOffset = 0;

function initialize(){
	
	getUrlVars();
	
	var first = getUrlVars()["UN"];

	// To get the second parameter
	var second = getUrlVars()["PW"];
	
// 	var username = 'mmmmikep';
 	 username = first;
 	
//     var password = 'icarus';
	 password = second;
	
	 var passwordHash = Crypto.MD5(password);
	 authString = btoa(username + ':' + passwordHash); 

	 var url = "http://api.untappd.com/v3/user?key=b6077c9e633e11b65375b25eea792597&user="+username;
	 var key = "key=b6077c9e633e11b65375b25eea792597";
	 var query = '&user=mmmmikep';

	 var userAPIcall = "http://api.untappd.com/v3/user?key=b6077c9e633e11b65375b25eea792597&user=";
	 var beerAPIcall = "http://api.untappd.com/v3/beer_search?key=b6077c9e633e11b65375b25eea792597&sort=count&q=";
	 var beerInfocall = "http://api.untappd.com/v3/beer_info?key=b6077c9e633e11b65375b25eea792597&bid=";
	 var untappdAPIcall="";
//	 var backbutton = "Back that thing up";
	 beerTrends();



}

function myBeers(){
	distinctOffset=0;

	}

///zcode 5/2/12
openPage = function() {
location.href = userAPIcall+username;
}




//preference activity

function beerTrends(){
	var trendURL = "http://api.untappd.com/v3/trending?key=b6077c9e633e11b65375b25eea792597&type=local&limit=10&age=monthly&geolat=33.216646&geolng=-97.133646";
	backbutton = $("#results").val;

	$.ajax(
			{
			url: trendURL,
			dataType: "json",		
			success:function(result){
				$("#status").html('<font color="#6A2C0C" size="3.5" face="Gill Sans"><b>Popular beers in the Denton area</b><br>Click on a beer for more info!</font><hr>');

			      $.each(result.results, 
			    		  function(i,beer){
				     	// this is where we do what we want with the beer
				      		$("#results").append('<font color="#6A2C0C" face="Gill Sans" size="2"><p onclick= "beerclick(' + beer.beer_id + ')"><img id="beerpic" title= "' + beer.beer_id + '" src="' + beer.img + '" width="48" height="48" />&nbsp;&nbsp;&nbsp;&nbsp;<b>' + beer.beer_name + '</b></p>');
						});	//end each function
			      }, //end success
			error: function(req, status, errThrown){
					$("#results").html("error:" + req + status + errThrown);
				}

	  });


}


function beerlist(url){
	url = 'http://api.untappd.com/v3/user_distinct?key=b6077c9e633e11b65375b25eea792597&user='+username+'&offset='+distinctOffset;
	var bidURL = url;
	var offset;
//	var testURL = 'http://api.untappd.com/v3/user_distinct?key=b6077c9e633e11b65375b25eea792597&user=mmmmikep';

	
	backbutton = $("#results").val;
	$("#status").html('<font color="#6A2C0C" face="Gill Sans">searching...</font>');

	$.ajax(
		{
		url:bidURL,
		dataType: "json",		
		success:function(result){
			bidURL=bidURL+"&offset=25";
			$("#status").html('<font color="#6A2C0C" face="Gill Sans"><b>Tap a beer for more info!</b></font>');

		      $.each(result.results, 
		    		  function(i,beer){
			     	// this is where we do what we want with the beer
			      		$("#results").append('<font color="#6A2C0C" size="2" face="Gill Sans"><b><p onclick="beerclick(' + beer.beer_id + ')"><img id="beerpic" title="' + beer.beer_id + '" src="' + beer.beer_stamp + '" width="48" height="48" />&nbsp;&nbsp&nbsp;' + beer.beer_name + '</b></font></p>');
						offset=i;
					});	//end each function
					//next page button not working for some reason
		      //$("#results").append('<button onclick="beerlist(http://api.untappd.com/v3/user_distinct?key=b6077c9e633e11b65375b25eea792597&user=mmmmikep&offset=25)">Next Page</button><br>');
		     // $("#results").append(bidURL);
		     
		     	distinctOffset = distinctOffset + offset + 1;
		     	nextURL = "http://api.untappd.com/v3/user_distinct?key=b6077c9e633e11b65375b25eea792597&user="+username+"&offset=" + distinctOffset;

		     	//next page button not working for some reason
		     	$("#nav").html('<button onclick="beerlist(&#34;'+nextURL+'&#34;)">More Beer?</button><br>');

		     	
					}, //end success
		error: function(req, status, errThrown){
				$("#results").html("error:" + req + status + errThrown);
			}

  });

}




function beerclick(uid){
	var bidURL = "http://api.untappd.com/v3/beer_info?key=b6077c9e633e11b65375b25eea792597&bid="+uid;
	backbutton = $("#results").val;
	var key = '';
	var Bindex=0;

	$("#status").html('Searching for...');
    $("#status").append(uid);

    $.ajax({url:bidURL,
     type:"GET",
     dataType: "json",
     beforeSend: function (xhr) {xhr.setRequestHeader('Authorization', 'Basic ' + authString); },
     success:function(result){

     $("#status").html("Rate, Review, and Check in to this beer!");
     $("#results").html('<p><img src="'+result.results.img+'" width="125" height="125""><br>'+result.results.name+'</p>'+
     '<p>'+result.results.type+' - ABV: '+result.results.beer_abv+'%</p>'+
     '<p>--'+result.results.brewery+'</p>');
    
     $("#results").append('My Rating: '+result.results.your_rating +'<br>');
     $("#results").append('Average Rating: '+result.results.avg_rating +"<br>");

     $("#nav").html('<button id="checkIn" onclick="beerCheckin('+uid+')">Check In!</button>');



    
     },
     error: function(req, status, errThrown){
     $("#results").html("error:" + req + status + errThrown);
     }

     });

	}

  function searchBeer(){
	  clearPage();
	  backbutton = $("#results").val;
	  $("#status").html("Searching...");

	  untappdAPIcall = "http://api.untappd.com/v3/beer_search?key=b6077c9e633e11b65375b25eea792597&sort=count&q="+$("#searchText").val();
	      $.getJSON("http://api.untappd.com/v3/beer_search?key=b6077c9e633e11b65375b25eea792597&sort=count&q="+$("#searchText").val(),function(json){
	
				if (json.returned_results == 0)
				{
					 $("#status").html("No results found. Try Again!");
					
				}
				else{
		    	  $("#status").html("Tap a beer for more info!");
				}

	        $.each(json.results, function(i,beer){
	       // this is where we do what we want with the beer
	        $("#results").append('<p onclick="beerclick('+beer.beer_id+')"><img id="beerpic" title="'+beer.beer_id+'" src="'+beer.beer_stamp+'" width="48" height="48" />'+beer.beer_name+'</p>');

	  });
	      
	  });
	    }
  

  function goBack(){
	  $("#results").html(""+backbutton);
  }
  
  function beerCheckin(id){
	  checkinURL="http://api.untappd.com/v3/checkin?key=b6077c9e633e11b65375b25eea792597";
	  $("#status").html("checking in... ");
	  var review=prompt("Please write a short review of this beer","Reviewed with DentonBierGarten");
	  var rating=prompt("Please review this beer on a scale from 1-5","0");
	  //var foursqID = '40e0b100f964a52021091fe3';
	  //data: { bid: id, gmt_offset: -6, shout: review, rating_value: rating, foursquare_id: venueID, user_lat: venueLat, user_lng: venueLng},



	  $.ajax({url: checkinURL,
	  type:"POST",
	  dataType: "json",
	  data: { bid: id, gmt_offset: -6, shout: review, rating_value: rating},
	  beforeSend: function (xhr) {xhr.setRequestHeader('Authorization', 'Basic ' + authString); },
	  success:function(result){
	  $("#status").html("Success! See recommendations below");
	  $("#nav").html('');
	  $("#results").html(result.beer_details.beer_name +'<br><img src="'+result.beer_details.img+'" width="72" length="72"><br>'+result.beer_details.brewery_name+'<br><hr>');
	  $.each(result.recommendations,
	  function(i,rec){
	  // this is where we do what we want with the beer
	  $("#results").append('<p onclick="beerclick('+rec.beer_id+')"><img id="beerpic" title="'+rec.beer_id+'" src="'+rec.img+'" width="48" height="48" />'+rec.beer_name+'</p>');
	  });





	  },
	  error: function(req, status, errThrown){
	  $("#results").html("error:" + req + status + errThrown);
	  }

	  });

	    }

  function clearPage(){
	  $("#results").html("");
	  $("#status").html("");
	  $("#nav").html("");
	  $("#searchText").val("");
	  

	    }

  
</script>		  


</head>
<body onload="initialize()" bgcolor="#f5ad03" style="margin: 0; padding: 0">

<style> body{ 
background-image:url("bubblybeerCorner.jpg");
background-repeat:no-repeat;
background-attachment:scrollable;
 



}</style>

<p><font color="#6A2C0C" face="Gill Sans" size="5"><b>Enter a beer to search</b></font></p>
<input type="text" id="searchText">
<button id="bSrch" onclick="searchBeer()"><span>Search&nbsp;&raquo;</span></button>
<button id="trend" onclick="beerTrends()">Popular Beers</button>
<!-- <button id="beers" onclick="beerlist('http://api.untappd.com/v3/user_distinct?key=b6077c9e633e11b65375b25eea792597&user=mmmmikep')">My Beers</button>-->
<!-- <button id="beers" onclick="beerlist('http://api.untappd.com/v3/user_distinct?key=b6077c9e633e11b65375b25eea792597&user=')">My Beers</button>-->


<button id="beers" onclick="myBeers();clearPage();beerlist('http://api.untappd.com/v3/user_distinct?key=b6077c9e633e11b65375b25eea792597&user=')">My Beers</button>

<button id="clearclick" onclick="clearPage()">Clear</button>

<br><br>
<!-- <button id="backButton" onclick="goBack()">Back</button> -->

<div id="status"></div>
<div id="nav"></div>
<div id="results"></div>

</body>
</html>


